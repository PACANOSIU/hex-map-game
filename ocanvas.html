<!DOCTYPE html>
<html>
<head>
<script src="ocanvas-2.7.1-beta.min.js"></script>
<script src="js/misc.js"></script>
<style>canvas {
    display: block;
    border:1px solid #222
}</style>
</head>
<body>
<canvas id="HexCanvas" width="1000" height="700"></canvas>
<script>
var canvas = oCanvas.create({
	canvas: "#HexCanvas"
});
var width = canvas.width;
var height = canvas.height;

function HexagonGrid(canvasId, radius) {
    this.radius = radius;
	this.side = (3 / 2) * radius;
	this.height = Math.sqrt(3) * radius;

	this.canvas = document.getElementById(canvasId);
    this.context = this.canvas.getContext('2d');
    this.canvasOriginX = 0;
    this.canvasOriginY = 0;
};

HexagonGrid.prototype.drawHexGrid = function (rows, cols, originX, originY, isDebug) {
    this.canvasOriginX = originX;
    this.canvasOriginY = originY;
    
    var currentHexX;
    var currentHexY;
    var debugText = "";

    var offsetColumn = false;

    for (var col = 0; col < cols; col++) {
        for (var row = 0; row < rows; row++) {

            if (!offsetColumn) {
                currentHexX = (col * this.side) + originX;
                currentHexY = (row * this.height) + originY;
            } else {
                currentHexX = col * this.side + originX;
                currentHexY = (row * this.height) + originY + (this.height * 0.5);
            }

            if (isDebug) {
                debugText = col + "," + row;
            }

            this.drawHex(currentHexX, currentHexY, "#ddd", debugText, col, row);
        }
        offsetColumn = !offsetColumn;
    }
	canvas.redraw();
};

HexagonGrid.prototype.drawHex = function(x0, y0, fillColor, debugText, col, row) {
	//Using ocanvas
	//Add text and ellipses first, so that the Hex layer is on top (for clicking)
	var hex = canvas.display.polygon({
		x: x0,
		y: y0,
		sides: 6,
		radius: this.radius,
		rotation: 0,
		fill: fillColor,
		stroke: "outside 1px #000",
		row: row,
		col: col,
		zIndex: "back",
		selected: false
	});
	hex.add(false);	
	hex.bind("click tap", function () {
		if(this.selected == false){
			this.selected = true;
			anySelected = true;
			//Highlighting selected Hex
			var hex = canvas.display.polygon({
				x: x0,
				y: y0,
				sides: 6,
				radius: this.radius,
				rotation: 0,
				stroke: "outside 4px #00F2FF"
			});
			hex.bind("click tap", function () {
				canvas.removeChild(hex);
				canvas.removeChild(rectangle);
				canvas.removeChild(text);
			});
			hex.add();
			//Attack button
			var rectangle = canvas.display.rectangle({
				x: width-100,
				y: 25,
				origin: { x: "center", y: "center" },
				width: 60,
				height: 35,
				fill: "#0aa",
				stroke: "10px #0aa",
				join: "round"
			});
			rectangle.bind("click tap", function () {
				console.log("Clicked Attack");
			});
			canvas.addChild(rectangle);
			//Text for Attack Button
			var text = canvas.display.text({
				x: width-100,
				y: 25,
				origin: { x: "center", y: "center" },
				align: "center",
				font: "bold 14px sans-serif",
				weight: "bold",
				text: "Attack",
				fill: "#000",
				pointerEvents: false
			});
			text.add();
		}else{
			this.selected = false	
		}
		console.log("Hex Positon: " + this.row + " " + this.col);
		canvas.redraw();
	});
	var randomColor = get_random_color();
	var text = canvas.display.text({
		x: x0,
		y: y0,
		origin: { x: "center", y: "center" },
		align: "center",
		font: "bold 14px sans-serif",
		weight: "bold",
		text: Math.floor((Math.random() * 9) + 1),
		fill: randomColor,
		pointerEvents: false
	});
	text.add(false);
	var ellipse = canvas.display.ellipse({
		x: x0,
		y: y0,
		radius: 10,
		stroke: "1px "+ randomColor,
		pointerEvents: false
	});
	ellipse.add(false);
};

HexagonGrid.prototype.getRelativeCanvasOffset = function() {
	var x = 0, y = 0;
	var layoutElement = this.canvas;
    if (layoutElement.offsetParent) {
        do {
            x += layoutElement.offsetLeft;
            y += layoutElement.offsetTop;
        } while (layoutElement = layoutElement.offsetParent);
        
        return { x: x, y: y };
    }
}

//Uses a grid overlay algorithm to determine hexagon location
//Left edge of grid has a test to acuratly determin correct hex
HexagonGrid.prototype.getSelectedTile = function(mouseX, mouseY) {

	var offSet = this.getRelativeCanvasOffset();

    mouseX -= offSet.x;
    mouseY -= offSet.y;

    var column = Math.floor((mouseX) / this.side);
	console.log("Column: " + column);
    var row = Math.floor(
        column % 2 == 0
            ? Math.floor((mouseY) / this.height)
            : Math.floor(((mouseY + (this.height * 0.5)) / this.height)) - 1);

	console.log("Row: " + row);
    //Test if on left side of frame            
    if (mouseX > (column * this.side) && mouseX < (column * this.side) + this.width - this.side) {

        //Now test which of the two triangles we are in 
        //Top left triangle points
        var p1 = new Object();
        p1.x = column * this.side;
        p1.y = column % 2 == 0
            ? row * this.height
            : (row * this.height) + (this.height / 2);

        var p2 = new Object();
        p2.x = p1.x;
        p2.y = p1.y + (this.height / 2);

        var p3 = new Object();
        p3.x = p1.x + this.width - this.side;
        p3.y = p1.y;

        var mousePoint = new Object();
        mousePoint.x = mouseX;
        mousePoint.y = mouseY;

        if (this.isPointInTriangle(mousePoint, p1, p2, p3)) {
            column--;

            if (column % 2 != 0) {
                row--;
            }
        }

        //Bottom left triangle points
        var p4 = new Object();
        p4 = p2;

        var p5 = new Object();
        p5.x = p4.x;
        p5.y = p4.y + (this.height / 2);

        var p6 = new Object();
        p6.x = p5.x + (this.width - this.side);
        p6.y = p5.y;

        if (this.isPointInTriangle(mousePoint, p4, p5, p6)) {
            column--;

            if (column % 2 == 0) {
                row++;
            }
        }
    }
    return  { row: row, column: column };
};


</script>
<script>
    var hexagonGrid = new HexagonGrid("HexCanvas", 22);
    hexagonGrid.drawHexGrid(15, 25, 25, 25, true);
</script>

</body>
</html>