<!DOCTYPE html>
<html>
<head>
<script src="js/ocanvas-2.7.1-beta.min.js"></script>
<script src="js/misc.js"></script>
<style>canvas {
    display: block;
    border:1px solid #222
}</style>
</head>
<body>
<canvas id="HexCanvas" width="1000" height="700"></canvas>
<script>
//Initialize canvas object
var canvas = oCanvas.create({
	canvas: "#HexCanvas"
});
var width = canvas.width;
var height = canvas.height;

//Initialize map array, randomize whether hex is filled or not
var map = new Array(10);
for (var i=0; i<map.length; i++){
	map[i] = new Array(10);
}
for (var i=0; i<map.length; i++){
	for (var j=0; j<map[i].length; j++){
		map[i][j] = Math.random()<.8;
	}
}

//Initialize storage arrays
//hex: hex object storage. ellipse: storing the circles around the unit numbers. units: the text value of units inside the hex/ellipse.  text: The text of attack button.  rectangle: the attack button itself.
var hex = [];			var ellipse = [];		var units = [];		
var text = [];			var rectangle = [];		var highlightAttack = [];
var highlighted = [];

var anySelectedHex = false;

function HexagonGrid(canvasId, radius) {   //function for the generic hexagon math
    this.radius = radius;
	this.side = (3 / 2) * radius;
	this.height = Math.sqrt(3) * radius;

	this.canvas = document.getElementById(canvasId);
    this.context = this.canvas.getContext('2d');
    this.canvasOriginX = 0;
    this.canvasOriginY = 0;
	
};

HexagonGrid.prototype.drawHexGrid = function (rows, cols, originX, originY, isDebug) {   //function for drawing the grid itself, including the math for offsetting hexagons row-by-row
    this.canvasOriginX = originX;
    this.canvasOriginY = originY;
   
    var currentHexX;
    var currentHexY;
    var debugText = "";
    var offsetColumn = false;

    for (var col = 0; col < cols; col++) {
        for (var row = 0; row < rows; row++) {
            if (!offsetColumn) {
                currentHexX = (col * this.side) + originX;
                currentHexY = (row * this.height) + originY;
            } else {
                currentHexX = col * this.side + originX;
                currentHexY = (row * this.height) + originY + (this.height * 0.5);
            }

            if (isDebug) {
                debugText = col + "," + row;
            }

            this.drawHex(currentHexX, currentHexY, "#ddd", debugText, col, row);
        }
        offsetColumn = !offsetColumn;
    }
	canvas.redraw();
};

HexagonGrid.prototype.drawHex = function(x0, y0, fillColor, debugText, col, row) {
	//Using ocanvas
	//Add text and ellipses first, so that the Hex layer is on top (for clicking)
	hex[row] = hex[row] || [];
	map[row] = map[row] || [];
	if(map[row][col]){
	hex[row][col] = canvas.display.polygon({
		x: x0,
		y: y0,
		sides: 6,
		radius: this.radius,
		rotation: 0,
		fill: fillColor,
		stroke: "outside 1px #000",
		row: row,
		col: col,
		zIndex: "back",
		selected: false,
		selectedType: ""
	});
	hex[row][col].add(false);	
	hex[row][col].bind("click tap", function () {
		if(anySelectedHex == false){
			hex[row][col].selected = true;
			//hex[row][col].selectedType = "highlight";
			//hex[row][col].stroke = "inside 2px #00F2FF";
			//hex[row][col].zIndex = "front";
			ellipse[row][col].zIndex = "front";
			ellipse[row][col].stroke = "outside 3px #00F2FF";
			ellipse[row][col].radius = ellipse[row][col].radius + 2;
			//units[row][col].zIndex = "front";
			//addHighlight(this.row, this.col, this.row, this.col, this.radius, "#00F2FF", "highlight");
			var button = addButton(row, col);
			anySelectedHex = true;
			console.log("Selected?: " + hex[row][col].selected);
		}else if(hex[row][col].selected == false && anySelectedHex == true){
			console.log("Selected?: " + hex[row][col].selected);
			hex[row][col].stroke = "inside 2px #ff0000";
			hex[row][col].selectedType = "attack";
			hex[row][col].selected = true;
			hex[row][col].zIndex = "front";
			ellipse[row][col].zIndex = "front";
			units[row][col].zIndex = "front";
			//addHighlight(this.row, this.col, highlighted.row, highlighted.col, this.radius, "#ff0000", "attack");
		}else if(hex[row][col].selected == true && anySelectedHex == true && hex[row][col].selectedType == "attack"){
			hex[row][col].stroke = "outside 1px #000";
			hex[row][col].zIndex = "front";
			units[row][col].zIndex = "front";
			ellipse[row][col].zIndex = "front";
			hex[row][col].selected = false;
		}else if (hex[row][col].selected == true && hex[row][col].selectedType == "highlight"){
			for(var i = 0; i<hex.length; i++){
				for(var j = 0; j<hex[row].length; j++){
					if(hex[i][j]){
						hex[i][j].stroke = "outside 1px #000";
						hex[i][j].zIndex = "front";
						units[i][j].zIndex = "front";
						ellipse[i][j].zIndex = "front";
						hex[i][j].selected = false;
					}
				}
			}
			anySelectedHex = false;
			console.log("Selected?: " + hex[row][col].selected);
		}
		canvas.redraw();
		//debug
		console.log("Hex Positon: " + this.row + " " + this.col);
		//console.log(hex[row][col]);
	});
	var randomColor = get_random_color();
	units[row] = units[row] || [];
	units[row][col] = canvas.display.text({
		x: x0,
		y: y0,
		origin: { x: "center", y: "center" },
		align: "center",
		font: "bold 14px sans-serif",
		weight: "bold",
		text: Math.floor((Math.random() * 9) + 1),
		fill: randomColor,
		pointerEvents: false
	});
	units[row][col].add(false);
	ellipse[row] = ellipse[row] || [];
	ellipse[row][col] = canvas.display.ellipse({
		x: x0,
		y: y0,
		radius: 10,
		stroke: "1px "+ randomColor,
		pointerEvents: false
	});
	ellipse[row][col].add(false);
	}
};
function addButton(row, col){
	//Attack button
	rectangle[row] = rectangle[row] || [];
	rectangle[row][col] = canvas.display.rectangle({
		x: width-100,
		y: 25,
		origin: { x: "center", y: "center" },
		width: 60,
		height: 35,
		fill: "#0aa",
		stroke: "10px #0aa",
		join: "round"
	});
	rectangle[row][col].bind("click tap", function () {
		console.log("Clicked Attack from Row " + row + " Column " + col);
	});
	canvas.addChild(rectangle[row][col]);
	//Text for Attack Button
	text[row] = text[row] || [];
	text[row][col] = canvas.display.text({
		x: width-100,
		y: 25,
		origin: { x: "center", y: "center" },
		align: "center",
		font: "bold 14px sans-serif",
		weight: "bold",
		text: "Attack",
		fill: "#000",
		pointerEvents: false
	});
	text[row][col].add();
};

function addHighlight (row, col, parentRow, parentCol, radius, color, type) { 
	if(type == "highlight"){	
		//Highlighting selected Hex
		
		//canvas.redraw();
		//hex[row][col].bind("click tap", function () {  //kill highlighting objects after clicking highlighted hex
		//	hex[row][col].stroke = "outside 4px #000";
		//	hex[row][col].zIndex = "back";
		//});	
		//highlighted = canvas.display.polygon({
		//	x: hex[row][col].x,
		//	y: hex[row][col].y,
		//	sides: 6,
		//	radius: radius,
		//	rotation: 0,
		//	stroke: "outside 4px " + color,
		//	type: type,
		//	row: row,
		//	col: col
		//});
		//highlighted.add();
		//highlighted.bind("click tap", function () {  //kill highlighting objects after clicking highlighted hex
		//	canvas.removeChild(highlighted);
		//	canvas.removeChild(rectangle[row][col]);
		//	canvas.removeChild(text[row][col]);
		//	hex[row][col].selected = false;
		//	anySelectedHex = false;
		//});	
	}
	if(type == "attack"){
		//Highlighting selected Hex
		hex[row][col].selected = true;
		highlighted = canvas.display.polygon({
			x: hex[row][col].x,
			y: hex[row][col].y,
			sides: 6,
			radius: radius,
			rotation: 0,
			stroke: "outside 4px " + color,
			type: type,
			parentRow: parentRow,
			parentCol: parentCol
		});
		highlighted.add();
		highlighted.bind("click tap", function () {  //kill highlighting objects after clicking highlighted hex
			canvas.removeChild(highlighted);
		});	
	}
};

var hexagonGrid = new HexagonGrid("HexCanvas", 22);
hexagonGrid.drawHexGrid(15, 25, 25, 25, true);





</script>

</body>
</html>